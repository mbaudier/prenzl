<project name="factory.mini">
	<import file="build.xml"/>
	
	<property name="mini.dist.dir" location="dist/PrenzlMini"/>
	<property name="mini.build.dir" location="build/PrenzlMini"/>
	
	<target name="mini.build" depends="init,prenzl.build.jni,stdrules.build.jni">
		<mkdir dir="${mini.build.dir}"/>
		<!-- Core -->
		<javac source="1.3" debug="true" destdir="${mini.build.dir}" 
			srcdir="${prenzl.java.home}/src">
			<include name="net/sf/prenzl/launch/*.java"/>
			<include name="net/sf/prenzl/adapter/*.java"/>
			<include name="net/sf/prenzl/computation/*.java"/>
			<include name="net/sf/prenzl/util/*.java"/>
			<include name="net/sf/prenzl/minimal/*.java"/>
			<classpath>
				<fileset dir="${factory.eclipse.dir}/swt" includes="swt.jar"/>
			</classpath>
		</javac>
		<!-- StdRules -->
		<javac source="1.3" debug="true" destdir="${mini.build.dir}" 
			srcdir="${stdrules.java.home}/src">
			<include name="net/sf/prenzl/stdrules/StdRules.java"/>
		</javac>

	</target>
	
	<target name="mini.dist" depends="mini.build">
		<mkdir dir="${mini.dist.dir}"/>
		<jar destfile="${mini.dist.dir}/prenzlmini_${prenzl.version}.jar">
		    <manifest>
				<attribute name="Class-Path" value="swt.jar"/>
				<attribute name="Specification-Version" value="${prenzl.release.version}"/>
				<attribute name="Implementation-Version" value="${prenzl.version}"/> 
				<attribute name="Implementation-Title" value="Prenzl minimal"/> 
		    </manifest>
			<fileset dir="${mini.build.dir}">
				<include name="**/*"/>
				<exclude name="net/sf/prenzl/minimal/**"/>
			</fileset>
		</jar>
		<jar destfile="${mini.dist.dir}/prenzlmini_boot.jar">
		    <manifest>
				<attribute name="Main-Class" value="net.sf.prenzl.minimal.Minimal"/>
				<attribute name="Class-Path" value="swt.jar prenzlmini_${prenzl.version}.jar"/>
				<attribute name="Specification-Version" value="${prenzl.release.version}"/>
				<attribute name="Implementation-Version" value="${prenzl.version}"/> 
				<attribute name="Implementation-Title" value="Prenzl minimal boot"/> 
		    </manifest>
			<fileset dir="${mini.build.dir}">
				<include name="net/sf/prenzl/minimal/**"/>
			</fileset>
		</jar>
		
		<copy file="${factory.eclipse.dir}/swt/swt.jar" todir="${mini.dist.dir}"/>
<!--
		<jar destfile="${mini.dist.dir}/swt.jar" update="true">
			<fileset dir="${factory.eclipse.dir}/swt">
				<include name="swt*.dll"/>
			</fileset>
		</jar>
		
		<jar destfile="${mini.dist.dir}/prenzlmini_${prenzl.version}.jar" update="true">
			<fileset dir="${prenzl.jni.home}/dist">
				<include name="*.dll"/>
			</fileset>
			<fileset dir="${stdrules.jni.home}/dist">
				<include name="*.dll"/>
			</fileset>
		</jar>
		-->
		<jar.nativelib nativedir="${prenzl.jni.home}/dist" 
			destjar="${mini.dist.dir}/prenzl.win32_${prenzl.version}.jar"/>
		<jar.nativelib nativedir="${stdrules.jni.home}/dist" 
			destjar="${mini.dist.dir}/stdrules.win32_${prenzl.version}.jar"/>
		<jar.nativelib nativedir="${factory.eclipse.dir}/swt" 
			destjar="${mini.dist.dir}/swt.win32.jar"/>
		<!--
		<copy file="${prenzl.jni.home}/dist/prenzl.dll" todir="${mini.dist.dir}"/>
		<copy file="${stdrules.jni.home}/dist/stdrules.dll" todir="${mini.dist.dir}"/>
		<copy file="${factory.eclipse.dir}/swt/swt.jar" todir="${mini.dist.dir}"/>
		<copy todir="${mini.dist.dir}">
			<fileset dir="${factory.eclipse.dir}/swt" includes="swt*.dll"/>
		</copy>
		-->
	</target>

	<target name="mini.sign" depends="mini.dist">
		<signjar alias="${keystore.alias}" storepass="${keystore.password}" keystore="keystore/keystore">
			<fileset dir="${mini.dist.dir}" includes="*.jar"/>
		</signjar>
	</target>
	
	<target name="mini.webstart" depends="mini.sign">
		<copy file="webstart/prenzlmini.jnlp" todir="${mini.dist.dir}">
			<filterset>
				<filter token="prenzl.version" value="${prenzl.version}"/>
			</filterset>
		</copy>
		<copy file="${prenzl.java.home}/icons/prenzl-32.gif" todir="${mini.dist.dir}"/>

		<property name="test.applet.dir" location="C:\Programs\EasyPHP1-8\www\prenzlmini"/>
		<copy todir="${test.applet.dir}">
			<fileset dir="${mini.dist.dir}" includes="*.jar"/>
			<fileset dir="${mini.dist.dir}" includes="*.jnlp"/>
 		</copy>
	</target>
	
	<target name="mini.clean" depends="clean">
		<delete dir="${mini.build.dir}"/>
		<delete dir="${mini.dist.dir}"/>
	</target>
	
	<macrodef name="jar.nativelib">
		<attribute name="destjar"/>
		<attribute name="nativedir"/>
		<sequential>
			<jar destfile="@{destjar}">
				<fileset dir="@{nativedir}">
					<include name="*.dll"/>
				</fileset>
			</jar>
		</sequential>
	</macrodef>
</project>